---
title: "NYSIPM_Sweet_Corn_Modeling"
author: "Chloe Cho"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(reshape2)
library(scales)
library(fitdistrplus)
library(lme4)

library(Boruta)
library(mlbench)
library(caret)
library(randomForest)

```

# Questions

- Splitting the pest models? Can use the economic threshold to create a binary outcome. 

# Data

## NYS IPM Data

### Read & Clean Data 

Data from NYS IPM (Marion Zuefle) for ECB_E, ECB_Z, CEW, FAW, and WBC. 

```{r}

sweet_corn_pest <- read.delim("NYSIPM_Sweet_Corn_1993_2022.csv", sep = ",")

sweet_corn_pest <- sweet_corn_pest %>% 
  mutate(Date = as.Date(Date, format = '%m/%d/%y')) %>%
  mutate(Site = as.factor(Site)) %>%
  mutate(USDA.hardiness.Zone = as.factor(USDA.hardiness.Zone)) %>%
  mutate(new_col = format(Date, "%j"), .after = Date) %>%
  rename(Day = new_col) %>%
  mutate(Day = as.numeric(Day)) 

sweet_corn_pest_long <- melt(sweet_corn_pest, id.vars = c("Site", "USDA.hardiness.Zone", "Lat", "Long", "Year", "Week", "Date", "Day"), measure.vars = c("ECB.E", "ECB.Z", "CEW", "FAW", "WBC"), variable.name = 'Pest', value.name = 'Count')

head(sweet_corn_pest_long)

```

### NYS Sites

```{r}

sites <- read.delim("NYSIPM_Sweet_Corn_1993_2022_Sites.csv", sep = ",")

length(levels(sites$Site))

sites <- sites %>% 
  mutate(Site = as.factor(Site)) 

sites <- sites %>%
  dplyr::select(-c('X', 'X.1', 'X.2', 'X.3', 'X.4', 'X.5', 'X.6', 'X.7'))

head(sites)

```

Add decimal GPS coordinates to table. 

```{r}

sites_decimal_gps <- sites %>%
  dplyr::select(c('Site', 'Lat.Decimal', 'Long.Decimal'))

sweet_corn_pest_full <- sweet_corn_pest_long %>%
  left_join(sites_decimal_gps, by = c("Site" = "Site"))

head(sweet_corn_pest_full)

```

## Feature Selection 

Testing a few different kinds of feature selection with current variables. Will add more as we get climate and soil data. 

Boruta feature selection. Read about Boruta [here](https://towardsdatascience.com/boruta-explained-the-way-i-wish-someone-explained-it-to-me-4489d70e154a).

```{r}

set.seed(42)

sweet_corn_pest_features <- sweet_corn_pest_full %>%
  dplyr::select(c('Site', 'Lat.Decimal', 'Long.Decimal', 'Year', 'Week', 'Date', 'Day', 'Pest', 'Count')) %>%
  na.omit(subset(sweet_corn_pest_full, select = c('Site', 'Lat.Decimal', 'Long.Decimal', 'Year', 'Week', 'Date', 'Day', 'Pest', 'Count')))

ecb_e_features <- sweet_corn_pest_features %>%
  dplyr::filter(Pest == 'ECB.E')

boruta_ecb_e <- Boruta(Count ~ ., data = na.exclude(ecb_e_features), doTrace = 2, maxRuns = 500)
print(boruta_ecb_e)

plot(boruta_ecb_e, las = 2, cex.axis = 0.7)

ecb_z_features <- sweet_corn_pest_features %>%
  dplyr::filter(Pest == 'ECB.Z')

boruta_ecb_z <- Boruta(Count ~ ., data = na.exclude(ecb_z_features), doTrace = 2, maxRuns = 500)
print(boruta_ecb_e)

plot(boruta_ecb_z, las = 2, cex.axis = 0.7)

cew_features <- sweet_corn_pest_features %>%
  dplyr::filter(Pest == 'CEW') 

boruta_cew <- Boruta(Count ~ ., data = na.exclude(cew_features), doTrace = 2, maxRuns = 500)
print(boruta_cew)

plot(boruta_cew, las = 2, cex.axis = 0.7)

faw_features <- sweet_corn_pest_features %>%
  dplyr::filter(Pest == 'FAW') 

boruta_faw <- Boruta(Count ~ ., data = na.exclude(faw_features), doTrace = 2, maxRuns = 500)
print(boruta_faw)

plot(boruta_faw, las = 2, cex.axis = 0.7)

wbc_features <- sweet_corn_pest_features %>%
  dplyr::filter(Pest == 'WBC') 

boruta_wbc <- Boruta(Count ~ ., data = na.exclude(wbc_features), doTrace = 2, maxRuns = 500)
print(boruta_wbc)

plot(boruta_wbc, las = 2, cex.axis = 0.7)


```

Run a random forest to select which features are most important. 

```{r}

ecb_e_rf <- randomForest(Count ~ Lat.Decimal + Long.Decimal + Year + Week + Date + Day, data = ecb_e_features, ntree = 500)
importance(ecb_e_rf)

ecb_z_rf <- randomForest(Count ~ Lat.Decimal + Long.Decimal + Year + Week + Date + Day, data = ecb_z_features, ntree = 500)
importance(ecb_z_rf)

cew_rf <- randomForest(Count ~ Lat.Decimal + Long.Decimal + Year + Week + Date + Day, data = cew_features, ntree = 500)
importance(cew_rf)

faw_rf <- randomForest(Count ~ Lat.Decimal + Long.Decimal + Year + Week + Date + Day, data = faw_features, ntree = 500)
importance(faw_rf)

wbc_rf <- randomForest(Count ~ Lat.Decimal + Long.Decimal + Year + Week + Date + Day, data = wbc_features, ntree = 500)
importance(wbc_rf)

```

## GLMM

### Selecting a Distribution

Negative binomial. 

```{r}

plot(fitdist(c(na.exclude(ecb_e_features$Count)),"nbinom"))

```

Poisson. 

```{r}

plot(fitdist(c(na.exclude(ecb_e_features$Count)),"pois"))

```

By comparing these two graphs, the negative binomial distribution fits the count data better than a Poisson distribution. This will be the distribution used in future models. 

### Running an Initial Model

Running an initial model with just the random effects.

```{r}

initial_model <- glmer.nb(Count ~ (1 | Site), data = sweet_corn_pest_full)
summary(initial_model)

```

# Adding Variables to Model

Running a model with individual predictors, no interactions. 

```{r}

ecb_e_1 <- glmer.nb(Count ~ scale(Lat.Decimal) + scale(Long.Decimal) + scale(Date) + (1 | Site), data = ecb_e_features)
summary(ecb_e_1)

```

# Adding Variables to Model

Running a model with individual predictors, no interactions. 

```{r}

ecb_e_model <- glmer.nb(Count ~ scale(Lat.Decimal) + scale(Date) + (1 | Site), data = ecb_e_features)
summary(ecb_e_model)

```

## Random Forest Classifier 

```{r}



```


## Xgboost 










