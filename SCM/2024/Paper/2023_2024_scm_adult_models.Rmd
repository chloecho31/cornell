---
title: "2023_2024_scm_adult_models"
author: "Chloe Cho"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(reshape2)
library(fitdistrplus)
library(lme4)
library(Boruta)
library(sjPlot)
library(jtools)
library(interactions)
library(DHARMa)
library(rsq)
library(effects)
library(readxl)
library(MuMIn)
library(latticeExtra) 
library(viridisLite)
library(performance)

set.seed(42)
```

```{r}

adult_features <- read.delim("all_features_2023_2024_scm_adults.csv", sep = ",")
adult_features

```

```{r}

adult_features <- adult_features %>%
  mutate(date_collected = as.Date(date_collected, '%Y-%m-%d')) %>%
  mutate(planting_date = as.Date(planting_date, '%Y-%m-%d')) %>%
  mutate_at(c('field_id', "previous_crop", "cover_crop", "manure", "tillage"), as.factor) %>% 
  dplyr::select(-c('card_id', 'X', 'total_scm', 'scm_male', 'scm_female', 'florilega', 'season_total', 'male_total', 'female_total', 'weekly_prop', 'weekly_prop_f', 'weekly_prop_m', 'season_prop'))


adult_features <- adult_features %>%
    mutate(previous_crop = case_when(previous_crop == 'Silage Corn' ~ 'Corn',
                           previous_crop == 'Grain Corn' ~ 'Corn',
                           previous_crop == 'Soybean' ~ 'Soybean',
                           TRUE ~ 'Other'))
  

adult_features <-adult_features %>% mutate_at('soil_texture', as.factor)
adult_features <-adult_features %>% mutate_at('year', as.factor)
adult_features <-adult_features %>% mutate_at('previous_crop', as.factor)
adult_features$date_collected_numeric <- as.numeric(adult_features$date_collected)


adult_features


```

```{r}

adult_features_selected <- adult_features %>%
  mutate(date_collected = as.Date(date_collected, '%Y-%m-%d')) %>%
  mutate_at(c('field_id', "previous_crop", "cover_crop", "manure", "tillage"), as.factor) %>% 
  dplyr::select(-c('prop_corn_previous_year_500m',
       'prop_ag_previous_year_500m', 'prop_nat_previous_year_500m','prop_corn_current_year_500m',
       'prop_ag_current_year_500m', 'prop_nat_current_year_500m'))
adult_features_selected




```

```

```{r}

plot(fitdist(adult_features$total_flies,"nbinom"))

```

```{r}
# Boruta with all features 

boruta <- Boruta(total_flies ~ ., data = na.exclude(adult_features), doTrace = 2, maxRuns = 500)

print(boruta)

png("boruta.png", width = 8, height = 6, units = "in", res = 300)
plot(boruta, las = 2, cex.axis = 0.35)

```

Dispersal (~1km/day before oviposition) - https://onlinelibrary.wiley.com/doi/10.1111/j.1570-7458.2012.01271.x
https://www.researchgate.net/publication/230003215_Dispersal_of_cabbage_root_fly

```{r}

features <- getSelectedAttributes(boruta, withTentative = F)
features

```


```{r}
# Boruta with selected features 

boruta <- Boruta(total_flies ~ ., data = na.exclude(adult_features_selected), doTrace = 2, maxRuns = 500)
print(boruta)

plot(boruta, las = 2, cex.axis = 0.45)

```

```{r}

features <- getSelectedAttributes(boruta, withTentative = T)
features

```



```{r}

model1 <- glmer.nb(total_flies ~ scale(date_collected) + cover_crop + previous_crop + scale(ppt_in) + scale(tmean_f) + scale(prop_corn_current_year_1000m) + scale(prop_ag_current_year_1000m) + scale(prop_nat_current_year_1000m) + scale(planting_date) + (1 | field_id), data = adult_features)

summary(model1)

```

```{r}

model2 <- glmer.nb(total_flies ~ scale(date_collected) + cover_crop + previous_crop + scale(tmean_f) + scale(prop_corn_current_year_1000m) + scale(prop_nat_current_year_1000m) + scale(planting_date) + (1 | field_id), data = adult_features)

summary(model2)

```

Climate * landscape
Management * landscape
Climate * management

```{r}

model3 <- glmer.nb(total_flies ~ scale(date_collected) + 
                     cover_crop + 
                     previous_crop + 
                     scale(tmean_f) + 
                     scale(prop_corn_current_year_1000m) + 
                     scale(prop_nat_current_year_1000m) + 
                     scale(planting_date) + 
                     scale(tmean_f) * scale(prop_corn_current_year_1000m) + 
                     scale(tmean_f) * scale(prop_nat_current_year_1000m) + 
                     cover_crop * scale(prop_corn_current_year_1000m) + 
                     cover_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(prop_corn_current_year_1000m) + 
                     previous_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(tmean_f) + 
                     scale(tmean_f) * cover_crop + 
                     (1 | field_id), data = adult_features)

summary(model3)

```

```{r}

options(na.action = "na.fail")
model3_dredge <- dredge(model3)
nrow(model3_dredge)
model3_dredge[1,]

best3 <- get.models(model3_dredge, delta==0)[[1]]
summary(best3)

```

```{r}

corn_effect <- predictorEffect("prop_corn_current_year_1000m", best3)
plot(corn_effect)

```

```{r}


corn_effect <- predictorEffect("prop_corn_current_year_1000m", best3)
plot(corn_effect)

```
Temperature does not interact with management. 

```{r}

model4 <- glmer.nb(total_flies ~ scale(date_collected) + cover_crop + previous_crop + scale(tmean_f) + scale(prop_corn_current_year_1000m) + scale(prop_nat_current_year_1000m) + scale(planting_date) + scale(tmean_f) * scale(prop_corn_current_year_1000m) + cover_crop * scale(prop_corn_current_year_1000m) + previous_crop * scale(prop_corn_current_year_1000m) + (1 | field_id), data = adult_features)

summary(model4)

```

```{r}

options(na.action = "na.fail")
model4_dredge <- dredge(model4)
nrow(model4_dredge)
model4_dredge[1,]

best4 <- get.models(model4_dredge, delta==0)[[1]]
summary(best4)

```


```{r}

options(na.action = "na.omit")
model5 <- glmer.nb(total_flies ~ scale(date_collected_numeric) + 
                     cover_crop + 
                     previous_crop + 
                     scale(tmean_f) + 
                     scale(prop_corn_current_year_1000m) + 
                     scale(prop_nat_current_year_1000m) + 
                     scale(planting_date) + 
                     scale(tmean_f) * scale(prop_corn_current_year_1000m) + 
                     scale(tmean_f) * scale(prop_nat_current_year_1000m) + 
                     cover_crop * scale(prop_corn_current_year_1000m) + 
                     cover_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(prop_corn_current_year_1000m) + 
                     previous_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(tmean_f) + 
                     scale(tmean_f) * cover_crop + 
                     (1 | field_id), data = adult_features)

summary(model5)

```

```{r}

options(na.action = "na.omit")
model6 <- glmer.nb(total_flies ~ scale(date_collected_numeric) + 
                     cover_crop + 
                     previous_crop + 
                     scale(tmean_f) + 
                     scale(prop_corn_current_year_1000m) + 
                     scale(prop_nat_current_year_1000m) + 
                     scale(planting_date) + 
                     scale(tmean_f) * scale(prop_corn_current_year_1000m) + 
                     scale(tmean_f) * scale(prop_nat_current_year_1000m) + 
                     cover_crop * scale(prop_corn_current_year_1000m) + 
                     cover_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(prop_corn_current_year_1000m) + 
                     previous_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(tmean_f) + 
                     scale(tmean_f) * cover_crop + 
                     (1 | field_id) + (1 | year), data = adult_features)

summary(model6)

```

```{r}

options(na.action = "na.omit")
model7 <- glmer.nb(total_flies ~ scale(date_collected_numeric) + 
                     cover_crop + 
                     previous_crop + 
                     scale(year) +
                     scale(tmean_f) + 
                     scale(prop_corn_current_year_1000m) + 
                     scale(prop_nat_current_year_1000m) + 
                     scale(planting_date) + 
                     scale(tmean_f) * scale(prop_corn_current_year_1000m) + 
                     scale(tmean_f) * scale(prop_nat_current_year_1000m) + 
                     cover_crop * scale(prop_corn_current_year_1000m) + 
                     cover_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(prop_corn_current_year_1000m) + 
                     previous_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(tmean_f) + 
                     scale(tmean_f) * cover_crop + 
                     (1 | field_id), data = adult_features)

summary(model7)

```

```{r}

options(na.action = "na.fail")
model5_dredge <- dredge(model5)
nrow(model5_dredge)
model5_dredge[1,]

best5 <- get.models(model5_dredge, delta==0)[[1]]
summary(best5)

```

```{r}

options(na.action = "na.fail")
model6_dredge <- dredge(model6)
nrow(model6_dredge)
model6_dredge[1,]

best6 <- get.models(model6_dredge, delta==0)[[1]]
summary(best6)

```


```{r}


```

```{r}

options(na.action = "na.omit")

model8 <- glmer.nb(total_flies ~ scale(date_collected_numeric) + 
                     cover_crop + 
                     previous_crop + 
                     scale(tmean_f) + 
                     scale(prop_corn_current_year_1000m) + 
                     scale(prop_nat_current_year_1000m) +  
                     scale(prop_semi_nat_current_year_1000m) + 
                     scale(planting_date) + 
                     scale(tmean_f) * scale(prop_corn_current_year_1000m) + 
                     scale(tmean_f) * scale(prop_nat_current_year_1000m) + 
                     cover_crop * scale(prop_corn_current_year_1000m) + 
                     cover_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(prop_corn_current_year_1000m) + 
                     previous_crop * scale(prop_nat_current_year_1000m) + 
                     previous_crop * scale(tmean_f) + 
                     scale(tmean_f) * cover_crop + 
                     soil_texture + ph + organic_matter +
                     (1 | field_id), data = adult_features)

summary(model8)


```

```{r}

adult_features$previous_crop <- ordered(adult_features$previous_crop, levels = c("Corn", "Soybean", "Other"))
levels(adult_features$previous_crop)

options(na.action = "na.fail")
model8_dredge <- dredge(model8)
nrow(model8_dredge)
model8_dredge[1,]

best8 <- get.models(model8_dredge, delta==0)[[1]]
summary(best8)


testDispersion(best8)
simulationOutput <- simulateResiduals(fittedModel = best8, plot = T)
residuals(simulationOutput)

testDispersion(simulationOutput)

r2_performance <- r2(best8)
print(r2_performance)

```

```{r}

quartzFonts(avenir = c("Avenir Book", "Avenir Black", "Avenir Book Oblique", "Avenir Black Oblique"))
par(family = "avenir")

corn_effect <- Effect("prop_corn_current_year_1000m", best8)
plot(corn_effect)

```

```{r}

ph_effect <- Effect("ph", best8)
plot(ph_effect, lines=list(col='#287a8c'))

```

```{r}

texture_effect <- Effect("soil_texture", best8)
plot(texture_effect, lines=list(col='#287a8c'))

```

```{r}

nat_effect <- Effect("prop_nat_current_year_1000m", best8)
plot(nat_effect, lines=list(col='#287a8c'))

```

```{r}

temp_effect <- Effect("tmean_f", best8)
plot(temp_effect, lines=list(col='#287a8c'))

```

```{r}

date_effect <- Effect("date_collected_numeric", best8)


plot(date_effect, axes=list(x=list(date_collected_numeric=list(lab="Date",
                                                 ticks=list(at=levels2dates(date_effect, "date_collected_numeric", "1970-01-01"))),
                                   rotate=45)), main="Date Effect")

```

```{r}

prev_crop_effect <- Effect(c('previous_crop'), best8)
plot(prev_crop_effect)

```

```{r}

temp_cc_effect <- Effect(c("tmean_f", 'cover_crop'), best8)
plot(temp_cc_effect, lines=list(multiline=TRUE, col=c('#413d7b', '#287a8c')), confint=list(style='bands', alpha=.3))

```

```{r}

prev_corn_effect <- Effect(c("previous_crop", 'prop_corn_current_year_1000m'), best8)
plot(prev_corn_effect, lines=list(multiline=TRUE, col=c('#413d7b', '#287a8c', '#7dba91')), confint=list(style='bands', alpha=.3))
plot(prev_corn_effect, lines=list(multiline=TRUE, col=c('#413d7b', '#287a8c', '#7dba91')))


```

```{r}

prev_nat_effect <- Effect(c("previous_crop", 'prop_nat_current_year_1000m'), best8)
plot(prev_nat_effect, lines=list(multiline=TRUE, col=c('#413d7b', '#287a8c', '#7dba91')), confint=list(style='bands', alpha=.1))
plot(prev_nat_effect, lines=list(multiline=TRUE, col=c('#413d7b', '#287a8c', '#7dba91')))


```

```{r}

temp_corn_effect <- Effect(c('prop_corn_current_year_1000m', "tmean_f"), best8, xlevels=6)
plot(temp_corn_effect)

```

```{r}

temp_nat_effect <- Effect(c('prop_nat_current_year_1000m', "tmean_f"), best8)
plot(temp_nat_effect)

```




```{r}

adult_features_early <- adult_features %>% filter(week < 21)
adult_features_early

```

```{r}

boruta_early <- Boruta(total_flies ~ ., data = na.exclude(adult_features_early), doTrace = 2, maxRuns = 500)
print(boruta_early)

png("boruta.png", width = 8, height = 6, units = "in", res = 300)
plot(boruta_early, las = 2, cex.axis = 0.35)



```

```{r}

eff_df <- as.data.frame(temp_nat_effect)

levelplot(fit ~ prop_nat_current_year_1000m * tmean_f, eff_df, 
          panel = panel.levelplot.points, cex = 0
    )  + 
    layer_(panel.2dsmoother(..., n = 100))

```

```{r}

eff_df <- as.data.frame(temp_corn_effect)

levelplot(fit ~ prop_corn_current_year_1000m * tmean_f, eff_df, 
          panel = panel.levelplot.points, cex = 0
    )  + 
    layer_(panel.2dsmoother(..., n = 100))

```


```{r}

#coul <- viridis(100)
levelplot(total_flies ~ prop_nat_current_year_1000m * tmean_f, adult_features, 
          panel = panel.levelplot.points, cex = 0.5
    )  + 
    layer_(panel.2dsmoother(..., n = 100))

```


